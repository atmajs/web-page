(function(t,n){"use strict";var e,r,i=!1;"undefined"==typeof exports||null!=t&&t!==exports&&t!==global||(e=global,i=!0),null==e&&(e="undefined"==typeof window?global:window),null==r&&(r=t||e),n(e,r),i&&(module.exports=r.Class)})(this,function(t,n){"use strict";function e(t){return"function"==typeof t}function r(t){return null!=t&&"number"==typeof t.length&&"function"==typeof t.slice}function i(t){return"string"==typeof t}function o(t){return"string"==typeof t&&""!==t}function u(t,n){if(s(t))for(var e=0,r=t.length;r>e;e++)n(t[e],e);else n(t)}function s(t){return null!=t&&"object"==typeof t&&"number"==typeof t.length&&"function"==typeof t.splice}function l(t){return"function"==typeof t?t.prototype:t}function c(t,n,e){var r,i;for(r in t)i=t[r],a(i)&&(null!=n&&a(n.prototype[r])&&p(i,n.prototype[r]),null!=e&&u(e,function(t){t=l(t),a(t[r])&&p(i,t[r])}))}function f(t){"function"==typeof t&&(t=t.prototype);for(var n,e,r=1,i=arguments.length;i>r;r++){n="function"==typeof arguments[r]?arguments[r].prototype:arguments[r];for(e in n)if("Static"!==e||null==t.Static)t[e]=n[e];else for(e in t.Static)t.Static[e]=t.Static[e]}return t}function h(t,n){if("object"!=typeof t||null==n)return t;for(var e,r=t,i=n.split("."),o=i.length,u=0;o>u;u++)if(e=i[u],r=r[e],null==r)return r;return r}function a(t){return null==t?!1:"object"!=typeof t?!1:t.constructor===Object}function p(t,n){for(var e in n)null==t[e]&&(t[e]=n[e]);return t}function g(t,n){for(var e in n)n[e]&&(t[e]=n[e]);return t}function d(t,n){return function(){switch(arguments.length){case 1:return t.call(n,arguments[0]);case 2:return t.call(n,arguments[0],arguments[1]);case 3:return t.call(n,arguments[0],arguments[1],arguments[2]);case 4:return t.call(n,arguments[0],arguments[1],arguments[2],arguments[3]);case 5:return t.call(n,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4])}return t.apply(n,arguments)}}function v(t){return"function"==typeof t}function y(t){var n=Array.prototype.slice.call(arguments,1);return function(){return arguments.length>0&&(n=n.concat(arguments)),t.apply(null,n)}}function _(n){if(this===E||null==this||this===t){var e=function(t){_.call(this,t)};return e.prototype._props=n,g(e.prototype,_.prototype),e}null!=n&&this.deserialize(n)}var m=Array.prototype.slice,w=Array.prototype.sort;"function"!=typeof Array.isArray&&(Array.isArray=function(t){return t instanceof Array?!0:null==t||"object"!=typeof t?!1:void 0!==t.length&&"function"==typeof t.slice});var b=function(){function t(t,n){if(null!=n){"function"==typeof t&&(t=t.prototype),"function"==typeof n&&(n=n.prototype);for(var e in n)t[e]=n[e]}}function n(t,n,e){var r=t[n],i=null==r?function(){}:function(t){return s(t)?r.apply(this,t):r.apply(this,arguments)};return function(){return this.super=i,e.apply(this,arguments)}}function e(e,r,o,s,l){var c=s,f=s;if(c.constructor=e.prototype.constructor,null!=o&&(f[i]={},u(o,function(n){t(f[i],n)}),f=f[i]),null!=r&&(f[i]=r.prototype),null!=l)for(var h in l)c[h]=n(c,h,l[h]);e.prototype=c}function r(n,e,r,i){if(null!=e){var o=function(){};o.prototype=e.prototype,n.prototype=new o,n.prototype.constructor=n}t(n.prototype,i),null!=r&&u(r,function(e){var r={};t(r,e),delete r.constructor;for(var i in r)n.prototype[i]=r[i]})}var i="__proto__",o=Object.prototype.toString,s=function(t){return"[object Arguments]"===o.call(t)};return"__proto__"in Object.prototype==!0?e:r}(),S=function(t,n){if(null!=n)if("function"!=typeof n)if(Array.isArray(n))for(var e=n.length,r=0;0!==e--;)S(t,n[r++]);else if(n.Static){n=n.Static;for(var i in n)n.hasOwnProperty(i)&&null==t[i]&&(t[i]=n[i])}else;else for(var i in n)"function"==typeof n[i]&&n.hasOwnProperty(i)&&null==t[i]&&(t[i]=n[i])},O={toJSON:function(){var t,n,e={};for(t in this)95!==t.charCodeAt(0)&&"Static"!==t&&"Validate"!==t&&(n=this[t],null!=n&&"function"!=typeof n&&(e[t]=n));return e}},j={};u(["get","del"],function(t){j[t]=function(n,e){this.promise[t](n).then(function(t,n){return t?(e.onError(t,n),void 0):(e.onSuccess(n),void 0)})}}),u(["post","put"],function(t){j[t]=function(n,e,r){this.promise[t](n,e).then(function(t,n){r(t,n)})}}),function(t){function n(t,n){return function(){return t.apply(n,arguments)}}function e(){this._callbacks=[]}function r(t){function n(t){return function(n,e){i+=1,u[t]=n,s[t]=e,i===r&&o.done(u,s)}}for(var r=t.length,i=0,o=new e,u=[],s=[],l=0;r>l;l++)t[l]().then(n(l));return o}function i(t,n,r){var o=new e;return 0===t.length?o.done(n,r):t[0](n,r).then(function(n,e){t.splice(0,1),i(t,n,e).then(function(t,n){o.done(t,n)})}),o}function o(t){var n="";if("string"==typeof t)n=t;else{var e=encodeURIComponent;for(var r in t)t.hasOwnProperty(r)&&(n+="&"+e(r)+"="+e(t[r]))}return n}function u(){var t;if(window.XMLHttpRequest)t=new XMLHttpRequest;else if(window.ActiveXObject)try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){t=new ActiveXObject("Microsoft.XMLHTTP")}return t}function s(n,r,i,s){function l(){c.abort(),h.done(t.promise.ETIMEOUT,"")}var c,f,h=new e;i=i||{},s=s||{};try{c=u()}catch(a){return h.done(-1,""),h}f=o(i),"GET"===n&&f&&(r+="?"+f,f=null),c.open(n,r),c.setRequestHeader("Content-type","application/x-www-form-urlencoded");for(var p in s)s.hasOwnProperty(p)&&c.setRequestHeader(p,s[p]);var g=t.promise.ajaxTimeout;if(g)var d=setTimeout(l,g);return c.onreadystatechange=function(){g&&clearTimeout(d),4===c.readyState&&(200===c.status?h.done(null,c.responseText):h.done(c.status,c.responseText))},c.send(f),h}function l(t){return function(n,e,r){return s(t,n,e,r)}}e.prototype.then=function(t,e){var r=n(t,e);this._isdone?r(this.error,this.result):this._callbacks.push(r)},e.prototype.done=function(t,n){this._isdone=!0,this.error=t,this.result=n;for(var e=0;this._callbacks.length>e;e++)this._callbacks[e](t,n);this._callbacks=[]};var c={Promise:e,join:r,chain:i,ajax:s,get:l("GET"),post:l("POST"),put:l("PUT"),del:l("DELETE"),ENOXHR:1,ETIMEOUT:2,ajaxTimeout:0};"function"==typeof define&&define.amd?define(function(){return c}):t.promise=c}(j),_.prototype={constructor:_,serialize:function(){return JSON.stringify(this)},deserialize:function(t){i(t)&&(t=JSON.parse(t));var n,r,o=this._props;for(n in t){if(null!=o&&(r=o[n],null!=r)){if(e(r)){this[n]=new r(t[n]);continue}var u=r.deserialize;if(e(u)){this[n]=u(t[n]);continue}}this[n]=t[n]}return this}};var A=function(){function t(t){this.route=r(t)}function n(t){var n=o.exec(t);return n?{optional:"?"===(n[2]||n[3]),parts:[n[1],n[4]]}:(n=u.exec(t))?{optional:"?"===n[3],parts:[n[1],n[4],n[5]]}:(console.error("Paths breadcrumbs should be match by regexps"),{parts:[t]})}function e(t,e){for(var r=t.split(e),i=0,o=r.length;o>i;i++)r[i]=n(r[i]);return r}function r(t){var n=/[^\:\{]\?[^:]/.exec(t),r=null;return n&&(n=n.index+1,r=t.substring(n+1),t=t.substring(0,n)),{path:e(t,"/"),query:null==r?null:e(r,"&")}}function i(t,n,e){for(var r,i,o,u=[],s=0,l=t.length;l>s;s++)if(o=t[s],i=o.parts.slice(0),null!=i[1]){if(r=i[1],i[1]=n[r],null!=i[1])u.push(i.join(""));else if(!o.optional)return console.error("Object has no value, for not optional part - ",r),null}else u.push(i[0]);return u.join(e)}t.prototype={constructor:t,create:function(t){var n,e;return n=i(this.route.path,t,"/"),null==n?null:this.route.query&&(e=i(this.route.query,t,"&"),null==e)?null:n+(e?"?"+e:"")}};var o=/^([^:\?]*)(\??):(\??)([\w]+)$/,u=/^([^\{\?]*)(\{(\??)([\w]+)\})?([^\s]*)?$/;return t}(),x={_isAsync:!0,_done:null,_fail:null,_always:null,_resolved:null,_rejected:null,deferr:function(){this._rejected=null,this._resolved=null},resolve:function(){this._fail=null,this._resolved=arguments;var t,n,e=this._done,r=this._always;if(this._done=null,this._always=null,null!=e){for(t=e.length,n=0;0!==t--;)e[n++].apply(this,arguments);e.length=0}if(null!=r)for(t=r.length,n=0;0!==t--;)r[n++].call(this,this);return this},reject:function(){this._done=null,this._rejected=arguments;var t,n,e=this._fail,r=this._always;if(this._fail=null,this._always=null,null!=e)for(t=e.length,n=0;0!==t--;)e[n++].apply(this,arguments);if(null!=r)for(t=r.length,n=0;0!==t--;)r[n++].call(this,this);return this},done:function(t){return null!=this._resolved?t.apply(this,this._resolved):(this._done||(this._done=[])).push(t),this},fail:function(t){return null!=this._rejected?t.apply(this,this._rejected):(this._fail||(this._fail=[])).push(t),this},always:function(t){return null!=this._rejected||null!=this._resolved?t.call(this,this):(this._always||(this._always=[])).push(t),this}},z=function(){function t(){this._listeners={}}return t.prototype={constructor:t,on:function(t,n){return(this._listeners[t]||(this._listeners[t]=[])).push(n),this},once:function(t,n){return n._once=!0,(this._listeners[t]||(this._listeners[t]=[])).push(n),this},pipe:function(t){var n,e=this,r=Array.prototype.slice;return function(){n=r.call(arguments),n.unshift(t),e.trigger.apply(e,n)}},trigger:function(){var t,n,e=Array.prototype.slice.call(arguments),r=e.shift(),i=this._listeners[r],o=0;if(null==i)return this;for(n=i.length;n>o;o++)t=i[o],t.apply(this,e),t._once===!0&&(i.splice(o,1),o--,n--);return this},off:function(t,n){var e=this._listeners[t];if(null==e)return this;if(1===arguments.length)return e.length=0,this;for(var r=e.length,i=0;r>i;i++)e[i]===n&&e.splice(i,1),i--,r--;return this}},t}(),T=function(){function t(t,e){if("function"==typeof e)return e.call(t);var r;for(var i in e)if(r=n(t,i,e[i]))return r}function n(t,n,e){var r=h(t,n);return e.call(t,r)}function e(n){var e;return null!=n.Validate&&(e=t(n,n.Validate))?e:void 0}return{validate:e}}(),E=function(t){var n,e=t.Base,i=t.Extends,o=t.Static,u=t.Construct,s=null,l=t.Store,f=t.Self,h=t.Override;if(null!=e&&delete t.Base,null!=i&&delete t.Extends,null!=o&&delete t.Static,null!=f&&delete t.Self,null!=u&&delete t.Construct,null!=l&&(null==i?i=l:r(i)?i.unshift(l):i=[l,i],delete t.Store),null!=h&&delete t.Override,void 0===t.toJSON&&(t.toJSON=O.toJSON),null==e&&null==i&&null==f){if(s=null==u?function(){}:u,t.constructor=s.prototype.constructor,null!=o)for(n in o)s[n]=o[n];return s.prototype=t,s}if(s=function(){if(null!=i)for(var t=i instanceof Array,n=t?i.length:1,r=null,o=0;t?n>o:1>o;o++)r=t?i[o]:i,"function"==typeof r&&r.apply(this,arguments);if(null!=e&&e.apply(this,arguments),null!=f)for(var s in f)this[s]=d(f[s],this);if(null!=u){var l=u.apply(this,arguments);if(null!=l)return l}return this},null!=o)for(n in o)s[n]=o[n];return null!=e&&S(s,e),null!=i&&S(s,i),c(t,e,i),b(s,e,i,t,h),t=null,o=null,s};E.bind=function(t){for(var n,e=arguments,r=1,i=arguments.length;i>r;r++)n=e[r],t[n]=t[n].bind(t);return t},E.Serializable=_,E.Deferred=x,E.EventEmitter=z,E.validate=T.validate,E.Collection=function(){function t(t,n){return n instanceof t?n:new t(n)}function n(t,n){return function(){return this.length=0,this._constructor=n,null!=t?t.apply(this,arguments):this}}function e(t,e){return e.Construct=n(e.Construct,t),f(e,i,r),E(e)}var r=function(){function n(t,n){if(null==n)return!1;if("function"==typeof n)return n(t);if("object"==typeof n){if(t.constructor===n.constructor&&t.constructor!==Object)return t===n;var e,r;for(var i in n){if(e=t[i],r=n[i],"string"==typeof r){var o=r[0],u=1;if("<"===o||">"===o)switch("="===r[1]&&(o+="=",u++),r=r.substring(u),o){case"<":if(e>=r)return!1;continue;case"<=":if(e>r)return!1;continue;case">":if(r>=e)return!1;continue;case">=":if(r>e)return!1;continue}}if(e!=r)return!1}return!0}return console.warn("No valid matcher",n),!1}var e={push:function(){for(var n=0,e=arguments.length;e>n;n++)this[this.length++]=t(this._constructor,arguments[n]);return this},pop:function(){var t=this[--this.length];return this[this.length]=null,t},shift:function(){if(0===this.length)return null;for(var t=this[0],n=this.length-1,e=0;n>e;e++)this[e]=this[e+1];return this[n]=null,this.length--,t},unshift:function(n){this.length++;for(var e=this.length;--e;)this[e]=this[e-1];return this[0]=t(this._constructor,n),this},splice:function(n,e){var r,i,o;if(n>=this.length)for(e=0,r=this.length,i=n;i>r;r++)this[r]=void 0;var u=e,s=n,l=n+u,c=arguments.length-2,f=this.length+c-u,h=l,a=this.length,p=f-this.length;if(p>0)for(r=a;--r>=h;)this[r+p]=this[r];if(0>p)for(r=h;a>r;)this[r+p]=this[r],r++;for(r=s,o=2;arguments.length>o;o)this[r++]=t(this._constructor,arguments[o++]);return this.length=f,this},slice:function(){return m.apply(this,arguments)},sort:function(t){return w.call(this,t),this},reverse:function(){for(var t=m.call(this,0),n=0,e=this.length;e>n;n++)this[n]=t[e-n-1];return this},toString:function(){return""+m.call(this,0)},each:function(t,n){for(var e=0,r=this.length;r>e;e++)t.call(n||this,this[e],e);return this},where:function(t){for(var e,r=new this.constructor,i=0,o=this.length;o>i;i++)e=this[i],n(e,t)&&(r[r.length++]=e);return r},remove:function(t){for(var e=-1,r=[],i=0,o=this.length;o>i;i++)n(this[i],t)?r.push(this[i]):this[++e]=this[i];for(i=++e;o>i;i++)this[i]=null;return this.length=e,r},first:function(t){if(null==t)return this[0];var n=this.indexOf(t);return-1!==n?this[n]:null},last:function(t){if(null==t)return this[this.length-1];var n=this.lastIndexOf(t);return-1!==n?this[n]:null},indexOf:function(t,e){if(null==t)return-1;if(null!=e){if(0>e&&(e=0),e>=this.length)return-1}else e=0;for(var r=this.length;r>e;e++)if(n(this[e],t))return e;return-1},lastIndexOf:function(t,e){if(null==t)return-1;if(null!=e){if(e>=this.length&&(e=this.length-1),0>e)return-1}else e=this.length-1;for(;e>-1;e--)if(n(this[e],t))return e;return-1}};return e}(),i={toArray:function(){for(var t=Array(this.length),n=0,e=this.length;e>n;n++)t[n]=this[n];return t}};return e}();var C={deserialize:function(t){if("string"==typeof t&&(t=JSON.parse(t)),s(t)){for(var n=0,e=t.length;e>n;n++)this.push(t[n]);return this}for(var r in t)this[r]=t[r];return this},serialize:function(){var t=this;return v(t.toArray)&&(t=t.toArray()),JSON.stringify(t)},fetch:null,save:null,del:null,onSuccess:null,onError:null,Static:{fetch:function(t){return(new this).fetch(t)}}};E.Remote=function(){var t=function(t){this._route=new A(t)};return f(t,C,x,{fetch:function(t){return j.get(this._route.create(t||this),this),this},save:function(t){return j.post(this._route.create(this),this.serialize(),t),this},del:function(t){return j.del(this._route.create(this),this.serialize(),t),this},onSuccess:function(t){var n;try{n=JSON.parse(t)}catch(e){return this.onError(e),void 0}this.deserialize(n),this.resolve(this)},onError:function(t){this.reject({error:t})}}),function(n){return new t(n)}}(),E.MongoStore=function(){var t,n,e,r,i,u,l="127.0.0.1",c=27017,h="test",a=function(t){t.ip&&(l=t.ip),t.port&&(c=t.port)};(function(){var s,f;t=function(n,e,r){return null==s?a(y(t,n,e,r)):(e=p(e),s.collection(n).findOne(e,function(t,n){r(t,n)}),void 0)},n=function(t,e,r){return null==s?a(y(n,t,e,r)):(e=p(e),s.collection(t).find(e,function(t,n){return t?(r(t),void 0):(n.toArray(function(t,n){r(t,n)}),void 0)}),void 0)},e=function(t,n,r){return null==s?a(y(e,t,n,r)):(s.collection(t).insert(n,r),void 0)},r=function(t,n,e){return null==s?a(y(r,t,n,e)):(s.collection(t).update({_id:p({_id:n._id})},n,{upsert:!0,multi:!1},function(t){e(t)}),void 0)},i=function(t,n,e){r(t,n.shift(),function(r){return r?e(r):0===n.length?e():(i(t,n,e),void 0)})},u=function(t,n,e,r){return null==s?a(u.bind(null,t,n,r)):(n=p(n),s.collection(t).remove(n,{justOne:e},function(t){r(t)}),void 0)};var a=function(){var t=[],n=!1;return function(e){if(s)return e(),void 0;if(t.push(e),!n){n=!0,f=require("mongodb");var r=f.MongoClient,i=f.Server;new r(new i(l,c,{auto_reconnect:!0})).open(function(n,e){s=e.db(h);for(var r,i=0,o=t.length;o>i;i++)r=t[i],r();t=null})}}}(),p=function(t){if(null==t)return 0!==arguments.length&&console.warn("<mongo> query should not be empty"),t;if(t.hasOwnProperty("$query")||t.hasOwnProperty("$limit"))return t;o(t._id)&&(t._id=f.ObjectID(t._id));var n={62:{0:"$gt",61:"$gte"},60:{0:"$lt",61:"$lte"}};for(var e in t){var r,i=t[e];if("string"==typeof i)switch(r=i.charCodeAt(0)){case 62:case 60:var u=n[r]["0"];61===i.charCodeAt(1)?(u=n[r]["61"],i=i.substring(2)):i=i.substring(1),t[e]={},t[e][u]=parseInt(i);continue}}return t}})();var p=function(){function n(t){t||console.error("<MongoStore> should define a collection name"),this._collection=t}f(n,C,x,{_busy:!1,fetch:function(n){return this._ensureFree()===!1?this:(t(this._collection,n,d(this._fetched,this)),this)},save:function(){if(this._ensureFree()===!1)return this;var t=this.serialize(),n=null!=t._id?e:r;return n(this._collection,t,d(this._completed,this)),this},del:function(){return this._ensureFree()===!1?this:(this._id?u(this._collection,{_id:this._id},!0,d(this._completed,this)):this._completed(),this)},Static:{fetch:function(t){return(new this).fetch(t)}},serialize:function(){var t,n,e={};for(t in this)(95!==t.charCodeAt(0)||"_id"===t)&&"Static"!==t&&"Validate"!==t&&(n=this[t],null!=n&&"function"!=typeof n&&(e[t]=n));return e},_ensureFree:function(){return this._busy?!1:(this._busy=!0,this._resolved=null,this._rejected=null,!0)},_completed:function(t){this._busy=!1,t?this.reject(t):this.resolve(this)},_fetched:function(t,n){this.deserialize(n),this._completed(t)}});var i=function(t){return new n(t)};return i.prototype=n.prototype,i}(),g=function(){function t(t){t||console.error("<MongoStore> should define a collection name"),this._collection=t}function r(t,n){var e=t._constructor,r=new e(n);null==r._id&&v(r.deserialize)&&r.deserialize(n),t[t.length++]=r}function o(t,n){var e;return function(r){r&&(e=r),0===--t&&n(e)}}f(t,x,{fetch:function(t){return this._ensureFree()===!1?this:(n(this._collection,t,d(this._fetched,this)),this)},save:function(){if(this._ensureFree()===!1)return this;for(var t,n=[],r=[],u=this._collection,s=d(this._completed,this),l=0,c=this.length;c>l;l++)t=this[l],null!=t._id?r.push(t.serialize()):n.push(t.serialize());if(n.length&&r.length){var f=o(2,s);return e(u,n,f),i(u,r,f),this}return n.length?(e(u,n,s),this):r.length?(i(u,r,s),this):this},del:function(t){if(null==t&&0!==arguments.length)return console.error("<MongoStore:del> - selector is specified, but is undefined"),this;if(this._ensureFree()===!1)return this;var n=null==t?this.toArray():this.remove(t);if(n&&n.length){for(var e,r=[],i=0,o=n.length;o>i;i++)e=n[i],e._id&&r.push(e._id);u(this._collection,{_id:{$in:r}},!1,d(this._completed,this))}else this._completed();return this},Static:{fetch:function(t){return(new this).fetch(t)}},_busy:!1,_ensureFree:function(){return this._busy?!1:(this._busy=!0,this._resolved=null,this._rejected=null,!0)},_completed:function(t){this._busy=!1,t?this.reject(t):this.resolve(this)},_fetched:function(t,n){if(s(n))for(var e,i=0,o=n.length;o>i;i++)e=n[i],r(this,e);else n&&r(this,n);this._completed(t)}});var l=function(n){return new t(n)};return l.prototype=t.prototype,l}();return{Single:p,Collection:g,settings:a}}(),function(){function t(t,n){if(t.length!==n.length)return!1;for(var e=t.length,r=0;e>r;r++)if(t[r]!==n[r])return!1;return!0}function n(n,e){if(0===e.length)return 0;for(var r=0,i=n.length;i>r;r++)if(t(n[r],e))return r+1;return n.push(e),n.length}function e(t){var e={},r=[];return function(){var i=n(r,arguments);return null==e[i]?e[i]=t.apply(this,arguments):e[i]}}function r(t,n,e){return function(){t[e]=arguments;for(var r,i=0,o=n[e].length;o>i;i++)r=n[e][i],r.apply(this,arguments);n[i]=null,t=null,n=null}}function i(t){var e={},i={},o=[];return function(){var u=Array.prototype.slice.call(arguments),s=u.pop(),l=n(o,u);return e[l]?(s.apply(this,e[l]),void 0):i[l]?(i[l].push(s),void 0):(i[l]=[s],u=Array.prototype.slice.call(u),u.push(r(e,i,l)),t.apply(this,u),void 0)}}E.Fn={memoize:e,memoizeAsync:i}}(),n.Class=E});